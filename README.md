# xkcd_poster

Автоматический бот, который загружает случайный комикс с xkcd и публикует его в Telegram-канал.

## Структура проекта

```
/xkcd_poster
|
|-- main.py             # Главный скрипт для запуска
|-- fetch_xkcd.py       # Модуль для работы с API xkcd
|-- download_utils.py   # Утилиты для загрузки файлов
|
|-- .env                # Файл с токеном и ID чата
|-- requirements.txt    # Список зависимостей
```

## Установка

```bash
pip install -r requirements.txt
```

## Настройка

Создайте файл `.env` в корне проекта и добавьте:

```dotenv
TG_BOT_TOKEN=YOUR_BOT_TOKEN
TG_CHAT_ID=YOUR_CHAT_ID
```

## Использование

```bash
python main.py
```

---

## Отчёт о доработке проекта по пяти ключевым правкам

В ходе работы над проектом были последовательно внесены улучшения, соответствующие пяти этапам, указанным в заданиях.

### **Правка 1: Фиксация версий пакетов**

**Задача:** Обеспечить стабильность и предсказуемость работы скрипта, защитив его от будущих несовместимых обновлений библиотек.

**Решение:** Был создан файл `requirements.txt` с жёстко зафиксированными версиями всех зависимостей.

**Итоговый файл `requirements.txt`:**
```ini
python-telegram-bot==13.15
requests==2.31.0
python-dotenv==1.0.1
# Явно указаны зависимости для решения проблемы установки 
urllib3<2
six==1.16.0
```

---

### **Правка 2: Уточнение названий переменных**

**Задача:** Улучшить читаемость кода, используя более информативные имена переменных.

**Решение:** В файле `fetch_xkcd.py` общее и малоинформативное имя переменной `data` было заменено на `comic_data`. Новое имя явно указывает на то, что в переменной хранятся данные, относящиеся к комиксу.

**Пример кода (`fetch_xkcd.py`):**
```python
# Было:
data = response.json()
img_url = data.get("img")

# Стало:
comic_data = response.json()
img_url = comic_data.get("img")
```

---

### **Правка 3: Разделение функции на части**

**Задача:** Привести код в соответствие с принципом единой ответственности, когда одна функция выполняет одну логическую задачу.

**Решение:** Изначально функция `download_file` выполняла две задачи: создание директории и скачивание файла. В ходе финального упрощения (см. Правку 5) необходимость в создании директории отпала полностью. Таким образом, эта задача была решена наиболее радикальным и эффективным способом: **функция `download_file` теперь занимается исключительно скачиванием файла**, а весь код, связанный с управлением директориями, был удалён как избыточный.

**Итоговый код (`download_utils.py`):**
```python
import requests

def download_file(url: str, filepath: str) -> None:
    """Скачивает файл по указанному URL и сохраняет его по указанному пути."""
    response = requests.get(url)
    response.raise_for_status()

    with open(filepath, 'wb') as f:
        f.write(response.content)
```

---

### **Правка 4: Корректировка обработки переменных окружения**

**Задача:** Сделать обработку обязательных конфигурационных параметров более строгой.

**Решение:** Для получения обязательных переменных `TG_BOT_TOKEN` и `TG_CHAT_ID` использование "мягкого" метода `os.getenv()` было заменено на прямой доступ к словарю `os.environ['KEY']`. Это гарантирует, что если переменная не будет найдена, программа немедленно прервётся с ошибкой `KeyError`, что является правильным поведением и упрощает отладку.

**Пример кода (`main.py`):**
```python
# Было:
# token = os.getenv('TG_BOT_TOKEN') # Могло вернуть None, требуя доп. проверки

# Стало:
try:
    token = os.environ['TG_BOT_TOKEN']
    chat_id = os.environ['TG_CHAT_ID']
except KeyError:
    print("Ошибка: Обязательные переменные TG_BOT_TOKEN и TG_CHAT_ID не найдены.")
    return
```

---

### **Правка 5: Высушивание кода (устранение избыточности)**

**Задача:** Сделать код максимально простым, удалив из него всё, что не является абсолютно необходимым для выполнения задачи. Эта правка объединила два ключевых упрощения.

**Решение (Часть 1 — отказ от `asyncio`):**
Изначально в коде было неоправданное использование асинхронности (`async`/`await`). Поскольку все используемые библиотеки (`requests`, `python-telegram-bot==13.15`) работают в синхронном режиме, `asyncio` был полностью удалён. Код стал линейным и более простым для понимания.

**Решение (Часть 2 — отказ от управления директориями):**
Было замечено, что создание отдельной папки `images/` и функции `ensure_directory_exists` для временного файла, который удаляется через несколько секунд, является избыточным.
*   Функция `ensure_directory_exists` была полностью **удалена**.
*   Скрипт был изменён так, чтобы временный файл `comic.png` создавался и удалялся в корневой директории проекта, без создания лишних папок.

**Пример итогового упрощения в `main.py`:**
```python
# Было:
# images_dir = "images"
# filepath = os.path.join(images_dir, "comic.png")

# Стало:
filepath = "comic.png"
```
В результате этих двух шагов код стал значительно короче, чище и прямолинейнее, полностью соответствуя принципу "делай как можно проще".